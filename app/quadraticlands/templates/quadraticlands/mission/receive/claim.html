{% extends 'quadraticlands/components/base.html' %}
{% load humanize static i18n %}

{% block 'twittercard' %}
	<!-- twitter card -->
	<meta name="twitter:card" content="summary" />
	<meta name="twitter:site" content="@gitcoin" />
	<meta name="twitter:title" content="title" />
	<meta name="twitter:description" content="description" />
	<meta name="twitter:image" content="https://s.gitcoin.co/static/quadraticlands/twittercards/xxxxx.gif" />
	<!-- end twitter card -->
{% endblock %}

{% block 'content' %}

<!-- hide footer, header as this is a fullscreen experience -->
{% include 'quadraticlands/components/fullscreen.html' %}



<section class="background">
	<img id="claimBackground" src="/static/quadraticlands/images/background/claim.svg">
</section>


<section class="quest">

	<!-- content-->
	<main>
		<div class="wrapper">

			{% if user.is_authenticated %}

			<div class="claim">

				<!-- headline -->
				<h3 id="claimHeadline"></h3>

				<!-- selected wallet adress -->
				<div id="claimAdress" class="claimAdress">
					<div class="receiveadress" id="wallet-address"></div>
				</div>
				
				<!-- details why you get X tokens -->
				<div id="claimListing" class="grid">
					<!-- @zach : need data from db + here a loop of one row -->
					<span class="description">Member of Gitcoin</span><span class="token">+200 GTC</span>
					<span class="description">Helpfull Person</span><span class="token">+100 GTC</span>
					<span class="description">Have a Grand</span><span class="token">+100 GTC</span>
					<span class="description">Have a Kudos</span><span class="token">+100 GTC</span>
					<span class="description">Staff</span><span class="token">+500 GTC</span>
					<!-- end loop -->
				</div>

				<!-- sum of this X tokens -->
				<div id="claimListingTotal" class="grid total">
					<span class="description">Total</span><span class="token">+1000 GTC</span>
				</div>

				<!-- just the x Tokens you get -->
				<h1 id="claimTokenAmount" class="hide">+1000 GTC</h1>

				<!-- a status message  -->
				<p id="claimStatusMessage" class="hide"></p>

				<!-- place for a link to a block explorer -->
				<p id="claimTXLink" class="hide"></p>

			</div>


			{% else %}

				<!--  richard: if user is not loged in, he should not SEE ANYTHING,
					not even a warning, he should even be able to come here without logged in 
					by controller ... not need to check or build views for this.  -->

			{% endif %}


		</div>
	</main>

	<!-- timer / seperator -->
	<div class="seperator"></div>

	<!-- bottom navigation -->
	<nav>

		<div class="left">
			<a href="/quadraticlands/">Exit</a>
		</div>

		<div class="center">
			Proof of Receive
		</div>

		<div class="right">
			
			<!-- a div to appear when claim:status claim -->
			<div id="divClaimButton" class="">
				<a id="beginClaim" class="btn" href="#">Claim</a>
				{% csrf_token %}
			</div>

			<!-- a div to appear when claim:status claiming -->
			<div id="divClaimingSpinner" class="hide">
				{% include "quadraticlands/_inlinesvg/spinner.svg" %}
			</div>

			<!-- a div to appear when claim:status claimed -->
			<div id="divClaimedButton" class="hide">
				<a class="btn" href="/quadraticlands/mission/receive/outro">Continue</a>
			</div>			

		</div>

	</nav>
	
</section>



{% endblock %}




{% block 'scripts' %}

<script src="{% static "v2/js/lib/ipfs-api.js" %}"></script>
<script src="{% static "v2/js/ipfs.js" %}"></script>
<script src="{% static "v2/js/tokens.js" %}"></script>
<script src="{% static "v2/js/abi.js" %}"></script>
<script src="{% static "v2/js/amounts.js" %}"></script>
<script src="{% static "v2/js/lib/secrets.min.js" %}"></script>
<script src="{% static "v2/js/ethereumjs-accounts.js" %}"></script>
<script src="/dynamic/js/tokens_dynamic.js"></script>

<!--APP - burger menu, wallet menu, provider select, collapse, flashMessage-->
<script src="/static/quadraticlands/js/app.js"></script>


<script>

// security token
const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;

// DOMContentLoaded
document.addEventListener("DOMContentLoaded",function(){

	// update the interface to the first initial state
	updateInterface('init');

	window.addEventListener('dataWalletReady', function(e) {
	    $('#wallet-address').html(selectedAccount)
	 }, false);

    console.log( "CLAIM DOCUMENT READY" );

	$(document).on('click', '#beginClaim', (event) => {

		console.log('BEGIN CLAIM');
		// console.log('selectedAccount', selectedAccount);
		// var sendForm = fetchData('/quadraticlands/claim2', 'POST', {'address':selectedAccount}, {'X-CSRFToken': csrftoken})

	    // confirm we have a working web3 connection if not, return error 
	    try {
	        const network = checkWeb3();
	    } catch (error) {
	        
	    	updateInterface('nowallet');

	        return console.log('Please confirm you have a wallet connected!!');
	    }



    	// ZW TODO - check that eth address is_valid before proceeding? - if not valid, return 


    	var getClaimData = fetchData('/quadraticlands/claim2', 'POST', {'address':selectedAccount}, {'X-CSRFToken': csrftoken});


		$.when(getClaimData).then((response, status, statusCode) => {
			//for debugging, remove for prod 
			console.log('POST RETURNED!', statusCode, response, status);

	        // if we don't get a 200 from the Ethereum Message Signing Service then return error  
	        if (statusCode.status != 200) {
	            console.log('getClaimData response: ', statusCode.status )
	            return //_alert(response.msg, 'error');
	        }
	       
	        // setup & send our contract call 
	        setupGTCTokenClaim(response);

	        // test zachs new ABI
	        // setupIsSigned(response)

	        // used for debugging if you want to confirm calling function after POST
	        // will be removed for prod 
	        // testClaim(response);


		});

	});

	// run other functions on load here

});






// setupGTCTokenClaim
//

async function setupGTCTokenClaim(emss_response) {

    const user_id = emss_response.user_id;
    const user_amount = emss_response.user_amount;
    const user_address_cleaned = web3.utils.toChecksumAddress(emss_response["user_address"].replace(/\"/g, ''));
    const eth_signed_message_hash_hex = emss_response.eth_signed_message_hash_hex.replace(/\"/g, '');
    const eth_signed_signature_hex = emss_response.eth_signed_signature_hex.replace(/\"/g, '');

	try {
		// who will send the transaction? (active user wallet account)
		[user] = await web3.eth.getAccounts();

		// ZW TODO - move token contract addy to env or standard abi.js file, added new Rinkeby tokendist contract 10/29/2020
      	// also, we will want to update the contract ABI at some point. it's old but still works as the function name is the same :) 
		const tokenDistributor = await new web3.eth.Contract(
			token_distributor_abi,
			'0xa4c8B8a59805F6B049b977296881CE76f538D7C4'
		);

		const claimGTCtokens = () => {

			// waitingState(true);

			tokenDistributor.methods
			.claimTokens(user_id, user_address_cleaned, web3.utils.toWei(user_amount, 'ether'), eth_signed_message_hash_hex, eth_signed_signature_hex)
          
			/** TODO - Evaluate optimal gas settings for token claims 
			* strat: hard coded price is fallback, dynamic real time gas adjustment is optimal  - how much gas can we save? 
			*  // Legacy Note- We hardcode gas limit otherwise web3's `estimateGas` is used and this will show the user
			*  // that their transaction will fail because the approval tx has not yet been confirmed
			*/

			.send({ from: user, gasLimit: '300000' })

			.on('transactionHash', async function(transactionHash) {

				// update interface to the pending view ( claiming )
				updateInterface('pending', transactionHash);
				console.log("ON TRANSACTION HASH - PENDING");
				console.log(transactionHash);
				
				// need to create DB models first before we can write txid to postgres db 
				// pushTXID2DB(transactionHash);

			})

			.on('receipt', receipt => {
				console.log("ON RECEIPT - WHAT EVER THIS IS");
			    console.log('receipt:', receipt);
			})

			.on('confirmation', (confirmationNumber, receipt) => {
				console.log("ON CONFIRMATION");
			    if (confirmationNumber >= 1) {
			    	// update interface to the success view ( claimed )
			    	updateInterface('success');
			    	console.log("ON CONFIRMATION >=1");
			    }
			})

			.on('error', (error) => { 
				// update interface to the generic error view
				updateInterface('error');
				console.log("ON ERROR");
			});

		};

		// now we run the function.
		//indicateMetamaskPopup();
		claimGTCtokens();

	} 

	catch (error) {
		// handleError(error);
		var errorMsg = 'catch error';
        console.log('errorMsg',errorMsg);
	}



}







//setupIsSigned
// zachs new ABI thing
//

async function setupIsSigned(emss_response) {
    
  const eth_signed_message_hash_hex = emss_response.eth_signed_message_hash_hex.replace(/\"/g, ''); // strip quotes 
  const eth_signed_signature_hex = emss_response.eth_signed_signature_hex.replace(/\"/g, ''); // strip quotes 
  
  try {
    // who will send the transaction? (active user wallet account)
    [user] = await web3.eth.getAccounts();
    // notes, this function calls the actual tokendist v2 ABI 
    const tokenDistributor_v2 = await new web3.eth.Contract(
      token_distributor_v2_abi,
      '0xa4c8B8a59805F6B049b977296881CE76f538D7C4'
    );
        
    const isSigned = () => {

        tokenDistributor_v2.methods
        .isSigned(eth_signed_message_hash_hex, eth_signed_signature_hex)
        .send({ from: user, gasLimit: '300000' })
        .on('transactionHash', async function(transactionHash) {})
        .on('receipt', receipt => {
              console.log('receipt:', receipt);
        })
        .on('confirmation', (confirmationNumber, receipt) => {
              if (confirmationNumber <= 5 ) {
                console.log('confirmations:', confirmationNumber, receipt);
              }
        })
        .on('error', (error) => { 
          const errorMsg = 'Oops, something went wrong with token claim. Please check transaction for more info, try again, and/or contact support@gitcoin.co';
          console.log('errorMsg',errorMsg);
        });

       
    };
    // make our contract call 
    isSigned();  
         

  } catch (error) {
    console.log('error on isClaimed: ', error)
    // handleError(error);
  }

}







// pushTXID2DB
//
function pushTXID2DB(transactionHash) {
    
    // check csrf token settings for second api fetch 
    var sendForm = fetchData('/quadraticlands/write-claim-TXID', 'POST', {'txid':transactionHash}, {'X-CSRFToken': csrftoken})
    $.when(sendForm).then((response, status, statusCode) => {
        // for debugging, remove for prod 
        console.log('POST RETURNED!', statusCode, response, status)
        
        // if we don't get a 200 from the database api then we return the error 
        if (statusCode.status != 200) {
            console.log('statusCode on pushTXID2DB: ', statusCode)
            return //_alert(response.msg, 'error');
        }
   });  

}




// checkNetwork
//
function checkNetwork() {
    const supportedNetworks = [ 'rinkeby', 'mainnet' ];
    
    if (!supportedNetworks.includes(document.web3network)) {
      flashMessage("Unsupported network",5000);
      throw new Error;
    }
    return document.web3network;
}


// checkWeb3
//
function checkWeb3() {
	if (!web3) {
		flashMessage("Please connect a wallet",5000);
		throw new Error;
	}
	return checkNetwork();
}


// handleError
//
function handleError(err) {
    console.error(err);
    let message = 'There was an error';
    
    if (err.message)
      message = err.message;
    else if (err.msg)
      message = err.msg;
    else if (err.responseJSON)
      message = err.responseJSON.message;
    else if (typeof err === 'string')
      message = err;
    
    flashMessage("Error:" + message ,5000);
    indicateMetamaskPopup(true);
}



// isNumeric
//
function isNumeric(n) {
    return !isNaN(parseFloat(n)) && isFinite(n);
}


// testClaim
//
async function testClaim(response) {
    try {
        console.log('testclaim: trigger successfully!');
        console.log('testClaim-response: ', response)
        console.log('user_id', response.user_id)
        const network = checkWeb3();
        
        // get current active wallet account 
        [user_active_account] = await web3.eth.getAccounts();
        console.log('user_active_account', user_active_account);

        //if response['user_address']

    } catch(error) { 
        console.log(error);
        handleError(error);
    }

}





// DYNAMIC USER INTERFACE 
// status = init, pending, success, nowallet, error

function updateInterface(status="init", transactionHash="") {

	// define block explorer for generating a link with txhash
	const blockExplorerLink = "https://rinkeby.etherscan.io/tx/";
	const blockExplorerName ="Etherscan";  

	// interface
	const claimBackground = document.getElementById("claimBackground");
	const claimHeadline = document.getElementById("claimHeadline");
	const claimListing = document.getElementById("claimListing");
	const claimListingTotal = document.getElementById("claimListingTotal");
	const claimTokenAmount = document.getElementById("claimTokenAmount");
	const claimStatusMessage = document.getElementById("claimStatusMessage");
	const claimTXLink = document.getElementById("claimTXLink");
	const divClaimButton = document.getElementById("divClaimButton");
	const divClaimingSpinner = document.getElementById("divClaimingSpinner");
	const divClaimedButton = document.getElementById("divClaimedButton");
	const claimAdress = document.getElementById("claimAdress");

	if (status=="init")
	{
		claimBackground.src = "/static/quadraticlands/images/background/claim.svg";
		claimHeadline.innerHTML = "Claim your GTC Tokens to:";
		claimTokenAmount.classList.add("hide");
		claimStatusMessage.innerHTML = "";
		claimStatusMessage.classList.add("hide");
		claimTXLink.classList.add("hide");
		claimListing.classList.remove("hide");
		claimListingTotal.classList.remove("hide");
		divClaimButton.classList.remove("hide");
		divClaimingSpinner.classList.add("hide");
		divClaimedButton.classList.add("hide");
		claimAdress.classList.remove("hide");
	}

	if (status=="pending")
	{
		claimBackground.src = "/static/quadraticlands/images/background/claiming.svg";
		claimHeadline.innerHTML = "Claiming <span>(Pending)</span>";
		claimTokenAmount.classList.remove("hide");
		claimStatusMessage.innerHTML = "The tokens are on the way...";
		claimStatusMessage.classList.remove("hide");
		claimTXLink.innerHTML = "<a target='_blank' href='"+blockExplorerLink+transactionHash+"'>"+blockExplorerName+"</a>";
		claimTXLink.classList.remove("hide");
		claimListing.classList.add("hide");
		claimListingTotal.classList.add("hide");
		divClaimButton.classList.add("hide");
		divClaimingSpinner.classList.remove("hide");
		divClaimedButton.classList.add("hide");
		claimAdress.classList.remove("hide");
		flashMessage("Your claim has been broadcast to the network!",5000);
	}

	if (status=="success")
	{
		claimBackground.src = "/static/quadraticlands/images/background/claimed.svg";
		claimHeadline.innerHTML = "Claimed";
		claimTokenAmount.classList.remove("hide");
		claimStatusMessage.innerHTML = "You successfully claimed some GTC Tokens. Welcome to the DAO.";
		claimListing.classList.add("hide");
		claimListingTotal.classList.add("hide");
		divClaimButton.classList.add("hide");
		divClaimingSpinner.classList.add("hide");
		divClaimedButton.classList.remove("hide");
		claimAdress.classList.remove("hide");
    	flashMessage("Transaction Confirmed",5000);
	}

	if (status=="error")
	{
		claimBackground.src = "/static/quadraticlands/images/background/claim.svg";
		claimHeadline.innerHTML = "Oops";
		claimTokenAmount.classList.remove("hide");
		claimStatusMessage.innerHTML = "Please check transaction for more info, try again, and/or contact support@gitcoin.co";
		claimTokenAmount.classList.add("hide");
		divClaimingSpinner.classList.add("hide");
		divClaimedButton.classList.add("hide");
		divClaimButton.classList.remove("hide");
		claimAdress.classList.remove("hide");
		flashMessage("Error",5000);
	}

	if (status=="nowallet")
	{
		claimBackground.src = "/static/quadraticlands/images/background/claim.svg";
		claimHeadline.innerHTML = "No Wallet found";
		claimTokenAmount.classList.add("hide");
		claimStatusMessage.innerHTML = "Please select a Wallet by going back to <a href='/quadraticlands/mission/receive'>Proof of Receive</a>";
		claimStatusMessage.classList.remove("hide");
		claimTXLink.classList.add("hide");
		claimListing.classList.add("hide");
		claimListingTotal.classList.add("hide");
		divClaimButton.classList.add("hide");
		divClaimingSpinner.classList.add("hide");
		divClaimedButton.classList.add("hide");
		claimAdress.classList.add("hide");
	}



}








</script>





{% endblock %}


