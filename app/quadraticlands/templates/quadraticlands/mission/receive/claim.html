 {% extends 'quadraticlands/components/base.html' %}
{% load humanize static i18n %}


{% block 'content' %}

<!-- hide footer, header as this is a fullscreen experience -->
{% include 'quadraticlands/components/fullscreen.html' %}



<section class="background">
	<img id="background" src='{% static "v2/quadraticlands/images/background/claim.svg" %}' />
</section>





<section class="quest">

	<!-- view : claim -->
	<main id="claim" class="hide">
		<div class="quest-claim glass">
			<div class="claim">
				<h3>Token Distribution</h3>

				<!-- claim and delegate address -->
				<div class="addresses">
					<div class="claim_address">
						<p>Send Tokens to</p>
						<div>
							<textarea id="claim_address" name="claim_address" readonly></textarea>
						</div>
						
					</div>

					<div class="delegate_address">
						<p>Delegation Address</p>
						<div>
							<!-- put the delegate_address wie safe in DB here where the dummy address is
								by including in example {{ delegate_address }} or so inside the text area -->
							<textarea id="delegate_address" name="delegate_address">{{ delegate_address }}</textarea>
						</div>
					</div>
				</div>

				<!-- details why you get X tokens -->
				<div id="claimListing" class="grid">
					<span class="description">Member of Gitcoin</span><span class="token">+200 GTC</span>
					<span class="description">Helpful Person</span><span class="token">+100 GTC</span>
					<span class="description">Have a Grand</span><span class="token">+100 GTC</span>
				</div>

				<!-- sum of this X tokens -->
				<div id="claimListingTotal" class="grid total">
					<span class="description">Total</span><span class="token">+{{ total_claimable_gtc }} GTC</span>
				</div>

			</div>
		</div>
	</main>


	<!-- view : claiming -->
	<main id="claiming" class="hide">
		<div class="quest-claim glass">
			<div class="claiming">
				<h3>Claiming <span>(Pending)</span></h3>
				<figure><img src="/static/quadraticlands/images/uni.svg"></figure>
				<h1>+{{ total_claimable_gtc }} GTC</h1>
				<p>Your governance tokens are on the way. <span id="transaction_link_pending"></span></p>
			</div>
		</div>	
	</main>


	<!-- view : claimed -->
	<main id="claimed" class="hide">
		<div class="quest-claim glass">
			<div class="claimed">
				<h3>Claimed</h3>
				<figure><img src="/static/quadraticlands/images/uni.svg"></figure>
				<h1>+{{ total_claimable_gtc }} GTC</h1>
				<p>You successfully claimed your GTC tokens. <span id="transaction_link_success"></span></p>
			</div>
		</div>	
	</main>


	<!-- view : error -->
	<main id="error" class="hide">
		<div class="quest-claim glass">
			<div class="error">
				<h3>Error</h3>
				<p>We're sorry, we were not able to process your claim. Please check  <span id="transaction_link_error"></span> for more info, try again, and/or contact support@gitcoin.co </p>
			</div>
		</div>	
	</main>



	<!-- timer / seperator -->
	<div class="seperator"></div>

	<!-- bottom navigation -->
	<nav class="glass">

		<div class="left">
			<a href="/quadraticlands/">Exit</a>
		</div>

		<div class="center">
			Proof of Receive
		</div>

		<div class="right">
			
			<!-- a div to appear when claim:status claim -->
			<div id="divClaimButton" class="hide">
				<a id="beginClaim" class="btn" href="#">Claim</a>
				{% csrf_token %}
			</div>

			<!-- a div to appear when claim:status claiming -->
			<div id="divClaimingSpinner" class="hide">
				{% include "quadraticlands/_inlinesvg/spinner.svg" %}
			</div>

			<!-- a div to appear when claim:status claimed -->
			<div id="divClaimedButton" class="hide">
				<a class="btn" href="/quadraticlands/mission/receive/outro">Continue</a>
			</div>			

		</div>

	</nav>
	
</section>



{% endblock %}




{% block 'scripts' %}

<!-- @zach do we realy need ALL these here ? -->
<!-- <script src="{% static "v2/js/lib/ipfs-api.js" %}"></script> -->
<!-- <script src="{% static "v2/js/ipfs.js" %}"></script> -->
<!-- <script src="{% static "v2/js/tokens.js" %}"></script> -->
<!-- <script src="{% static "v2/js/abi.js" %}"></script> -->
<!-- <script src="{% static "v2/js/amounts.js" %}"></script> -->
<!-- <script src="{% static "v2/js/lib/secrets.min.js" %}"></script> -->
<!-- <script src="{% static "v2/js/ethereumjs-accounts.js" %}"></script> -->
<!-- <script src="/dynamic/js/tokens_dynamic.js"></script> -->


<!-- custom particles-->
<script src="{% static "v2/quadraticlands/js/particles.js" %}"></script>

<!-- force web3modal to popup automaticaly when no provider selected-->
<script src="{% static "v2/quadraticlands/js/forceWallet.js" %}"></script>




<script>

// security token
const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;

// DOMContentLoaded
document.addEventListener("DOMContentLoaded",function(){

	// update the interface to the first initial state
	// to debug other stages goto console and type

	updateInterface('init');
	//updateInterface('pending');
	//updateInterface('success');
	//updateInterface('error');


	window.addEventListener('dataWalletReady', function(e) {

		// show selectedAccount in textarea claim_address
		const claim_address = document.getElementById("claim_address")
		claim_address.value = selectedAccount
	    console.log ("claim_address:" + selectedAccount)

	    // show selectedAccount in textarea delegate_address
	    // when there was no delegate address rendered to this page
	    const delegate_address_textarea = document.getElementById('delegate_address')
		if (delegate_address_textarea.value == '') {
			delegate_address_textarea.value = selectedAccount
			console.log("no delegate_address found in textarea - replacing it with selectedAccount:" + selectedAccount)
		}

	 }, false);

    console.log( "CLAIM DOCUMENT READY" );


	$(document).on('click', '#beginClaim', (event) => {

		console.log('BEGIN CLAIM');

	    // confirm we have a working web3 connection if not, return error 
	    // this might never be the case, as we force anyway a wallet connection
	    // that pops up when no web3 connection.
	    try {
	        const network = checkWeb3();
	    } catch (error) {
	        return console.log('Please confirm you have a wallet connected!!');
	    }

		/** 
		 * POST to claim endpoint 
		 * provided active account/address (claim address) & delegate address
		 * returns signed claim message data 
		**/

		// working before delegate set add 
		// var getClaimData = fetchData('/quadraticlands/claim', 'POST', {'address':selectedAccount}, {'X-CSRFToken': csrftoken});

		// read delegate_address from textarea
		var delegate_address = document.getElementById("delegate_address").value
		console.debug("DELEGATE TO ", delegate_address)
	
		var getClaimData = fetchData('/quadraticlands/claim', 'POST', {
			'address':selectedAccount, 
			'delegate':delegate_address
		}, {'X-CSRFToken': csrftoken});


		$.when(getClaimData).then((response, status, statusCode) => {
			//for debugging, remove for prod 
			console.log('CLAIM RETURNED!', statusCode, response, status);

			// if we don't get a 200 from the Ethereum Message Signing Service then return error
			// need to confirm this works as expected, empty return probably not what we want...  
	        if (statusCode.status != 200) {
	            console.log('getClaimData response: ', statusCode.status )
	            return //_alert(response.msg, 'error');
	        }
	       
	        // setup & send our contract call 
	        setupGTCTokenClaim(response);
		});

	});
    
	// run other functions on load here

});






// setupGTCTokenClaim
async function setupGTCTokenClaim(emss_response) {

    const user_id = emss_response.user_id;
    const user_amount = emss_response.user_amount;
	const user_address_cleaned = web3.utils.toChecksumAddress(emss_response["user_address"].replace(/\"/g, ''));
	const delegate_address_cleaned = web3.utils.toChecksumAddress(emss_response["delegate_address"].replace(/\"/g, ''));
    const eth_signed_message_hash_hex = emss_response.eth_signed_message_hash_hex.replace(/\"/g, '');
    const eth_signed_signature_hex = emss_response.eth_signed_signature_hex.replace(/\"/g, '');

	try {
        // zak TODO - make sure we only get first address, not array 
		[user] = await web3.eth.getAccounts();

		const tokenDistributor = await new web3.eth.Contract(
			token_distributor_abi,
			token_distributor_address()
		);

		const claimGTCtokens = () => {
			
			/** 
			 * @Richard, I think we might want to implement something here to let a user know the TX send is in process
			 * for example, once a user clicks send, it can take 5-10 seconds before a on.receipt or on.confirm fires
			 * users can/will be confused maybe and hit send again. Even just a message that lets them know the TX has been broadcast might be good 
			 * for example, "your claim has been broadcast! please stand by for confirmation."  
			 * This is what waitingState was used for in other parts of the app I think
            **/

			// waitingState(true);

			tokenDistributor.methods
			.claimTokens(user_id, user_address_cleaned, web3.utils.toWei(user_amount, 'ether'), delegate_address_cleaned, eth_signed_message_hash_hex, eth_signed_signature_hex)
       
			.send({ from: user, gasLimit: '300000' })

			.on('transactionHash', async function(transactionHash) {

				// update interface to the pending view ( claiming )
				updateInterface('pending', transactionHash);
				console.log("ON TRANSACTION HASH - PENDING");
				console.log(transactionHash);

			})

			.on('receipt', receipt => {
				// https://web3js.readthedocs.io/en/v1.2.0/web3-eth.html#eth-gettransactionreceipt-return
				// you can read about receipt vs confirm on the link above ^^ 
				// @Richard is there a reason we want/need to call this? if not, lets remove  
				console.log("ON RECEIPT - WHAT EVER THIS IS");
			    console.log('receipt:', receipt);
			})

			.on('confirmation', (confirmationNumber, receipt) => {
				console.log("ON CONFIRMATION");
			    if (confirmationNumber >= 1) {
			    	// update interface to the success view ( claimed )
			    	updateInterface('success');
			    	console.log("ON CONFIRMATION >=1");
			    }
			})

			.on('error', (error) => { 
				// update interface to the generic error view
				// @Richard, we should send something other than 'error', like the actual error or a generic message.
				// for example. "we're sorry, there was an issue with your tokenclaim, please contact support for more info" 
				updateInterface('error');
				console.error("Error-2 on TX send:", error);
			});

		};

		// now we run the function.
	    claimGTCtokens();

	} 

	catch (error) {
        console.error("Error-1 on TX send:", error);
	}



}


// checkNetwork
//
function checkNetwork() {
    const supportedNetworks = [ 'rinkeby', 'mainnet' ];
    
    if (!supportedNetworks.includes(document.web3network)) {
      flashMessage("Unsupported network",5000);
      throw new Error;
    }
    return document.web3network;
}


// checkWeb3
//
function checkWeb3() {
	if (!web3) {
		flashMessage("Please connect a wallet",5000);
		throw new Error;
	}
	return checkNetwork();
}


// handleError
// @Richard do we intend to use this? if not, lets remove. 
function handleError(err) {
    console.error(err);
    let message = 'There was an error';
    
    if (err.message)
      message = err.message;
    else if (err.msg)
      message = err.msg;
    else if (err.responseJSON)
      message = err.responseJSON.message;
    else if (typeof err === 'string')
      message = err;
    
    flashMessage("Error:" + message ,5000);
    indicateMetamaskPopup(true);
}



// isNumeric
//
function isNumeric(n) {
    return !isNaN(parseFloat(n)) && isFinite(n);
}



// DYNAMIC USER INTERFACE 
// status = init, pending, success, error

function updateInterface(status="init", transactionHash="") {

	// main views
	const view_claim = document.getElementById("claim");
	const view_claiming = document.getElementById("claiming");
	const view_claimed = document.getElementById("claimed");
	const view_error = document.getElementById("error");

	// define block explorer for generating a link with txhash
	const blockExplorerLink = "https://rinkeby.etherscan.io/tx/";
	const blockExplorerName ="Etherscan";  

	// background
	const background = document.getElementById("background");

	// dynamic bottom bar
	const divClaimButton = document.getElementById("divClaimButton");
	const divClaimingSpinner = document.getElementById("divClaimingSpinner");
	const divClaimedButton = document.getElementById("divClaimedButton");	

	// transaction links
	const transaction_link_pending = document.getElementById("transaction_link_pending")
	const transaction_link_success = document.getElementById("transaction_link_success")
	const transaction_link_error = document.getElementById("transaction_link_error")

	if (status=="init")
	{
		// switch view to
		view_claim.classList.remove("hide")
		view_claiming.classList.add("hide")
		view_claimed.classList.add("hide")
		view_error.classList.add("hide")

		// dynamic bottom bar
		divClaimButton.classList.remove("hide")
		divClaimingSpinner.classList.add("hide")
		divClaimedButton.classList.add("hide")

		// background
		background.src = '{% static "v2/quadraticlands/images/background/claim.svg" %}';

	}


	if (status=="pending")
	{
		// switch view to
		view_claim.classList.add("hide")
		view_claiming.classList.remove("hide")
		view_claimed.classList.add("hide")
		view_error.classList.add("hide")

		// dynamic bottom bar
		divClaimButton.classList.add("hide")
		divClaimingSpinner.classList.remove("hide")
		divClaimedButton.classList.add("hide")

		// background
		background.src = '{% static "v2/quadraticlands/images/background/claiming.svg" %}';		

		// build an etherscan link for this transaction
		link = "<a target='_blank' href='"+blockExplorerLink+transactionHash+"'>"+blockExplorerName+"</a>"
		transaction_link_pending.innerHTML = link
		transaction_link_success.innerHTML = link
		transaction_link_error.innerHTML = link

		// notification
		flashMessage("Your claim has been broadcast to the network!",5000);
	}


	if (status=="success")
	{
		// switch view to
		view_claim.classList.add("hide")
		view_claiming.classList.add("hide")
		view_claimed.classList.remove("hide")
		view_error.classList.add("hide")

		// dynamic bottom bar
		divClaimButton.classList.add("hide")
		divClaimingSpinner.classList.add("hide")
		divClaimedButton.classList.remove("hide")

		// background
		background.src = '{% static "v2/quadraticlands/images/background/claimed.svg" %}';

		// notification
    	flashMessage("Transaction Confirmed",5000);
	}


	if (status=="error")
	{
		// switch view to
		view_claim.classList.add("hide")
		view_claiming.classList.add("hide")
		view_claimed.classList.add("hide")
		view_error.classList.remove("hide")

		// dynamic bottom bar
		divClaimButton.classList.add("hide")
		divClaimingSpinner.classList.add("hide")
		divClaimedButton.classList.add("hide")

		// background
		background.src = '{% static "v2/quadraticlands/images/background/claim.svg" %}';

		// notification
		flashMessage("Error",5000);
	}

	


}









</script>
{% endblock %}


