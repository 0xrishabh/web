{% extends 'quadraticlands/components/base.html' %}
{% load humanize static i18n %}


{% block 'content' %}

<!-- hide footer, header as this is a fullscreen experience -->
{% include 'quadraticlands/components/fullscreen.html' %}


<section class="background">
	<img src='{% static "v2/quadraticlands/images/background/anim-9.svg" %}' />
</section>


<section class="quest">


	<!-- quest-intro : text -->
	<!-- kevin talked about having not text intro but video intro
	<main id="intro" class="hide">
		<div class="wrapper">
			<div class="quest-intro glass">
				<h3>Introduction</h3>
				<h1>Gitcoinâ€™s Core Values</h1>
				<p style="margin-bottom:2em;">Influence our principles of our living constitution by balance your voting power to the core values you care the most by drag some sliders.</p>			
			</div>
		</div>
	</main>
	-->


	<!-- quest-intro : video  -->
	<main id="intro" class="hide">
		<div class="wrapper">
			<div class="quest-video">
				<iframe src="https://www.youtube.com/embed/QtgFm38ck0k?rel=0" frameborder="0"allowfullscreen></iframe>
			</div>
		</div>
	</main>
	

	<!-- quest-vote -->
	<main id="voting" class="hide">
		<div class="wrapper">
			<div class="quest-vote">
				{% include 'quadraticlands/components/quest-vote-option.html' with name="Self Reliance" %}
				{% include 'quadraticlands/components/quest-vote-option.html' with name="Collaboration" %}
				{% include 'quadraticlands/components/quest-vote-option.html' with name="Intellectual Honesty" %}
				{% include 'quadraticlands/components/quest-vote-option.html' with name="Empathy" %}
				{% include 'quadraticlands/components/quest-vote-option.html' with name="Stress Reducers" %}
				{% include 'quadraticlands/components/quest-vote-option.html' with name="Inclusivity" %}
				{% include 'quadraticlands/components/quest-vote-option.html' with name="Giving First" %}
			</div>
		</div>
	</main>



	<!-- timer / seperator -->
	<div class="seperator">
		<div id="progressbar" style="width:0px"></div>
	</div>



	<!-- bottom navigation -->
	<nav class="glass">

		<div class="left">
			<a href="/quadraticlands/">Exit</a>
		</div>

		<div class="center">
			Proof of Use
		</div>

		<!-- button status -->
		<div class="right">

			<!-- intro - start voting process -->
			<div id="btnStart" class="hide" >
				<a class="btn">Start</a>
			</div>

			<!-- voting submit -->
			<div id="btnVoting" class="hide" >
				<a class="btn" id="signTypedDataV4Button" >Submit</a>
			</div>

			<!-- availablePercent left  -->
			<div id="availablePercent" class="hide" style="color:var(--aqua);"><span>100</span>% left</div>

			<!-- finish - goto outro -->
			<div id="btnOutro" class="hide" >
				<a class="btn" href="/quadraticlands/mission/use/outro">Continue</a>
			</div>


		</div>

	</nav>
	

</section>





{% endblock %}






{% block 'scripts' %}

<!-- custom particles-->
<script src="{% static "v2/quadraticlands/js/particles.js" %}"></script>

<!-- force web3modal to popup automaticaly when no provider selected-->
<script src="{% static "v2/quadraticlands/js/forceWallet.js" %}"></script>


<script>


document.addEventListener("DOMContentLoaded",function(){

	const inputs = document.querySelectorAll("input")

	/*********** VIEW ON LOAD */
	updateInterface("intro")
	updateInterface("voting")



	/*********** VIEW:VOTING > INPUT FIELD CHANGE EVENT */

	inputs.forEach(i => {

		i.addEventListener('focus', (event) => {
			// reset all options to not have class .active
			document.querySelectorAll(".option").forEach(r => { r.classList.remove("active") })
			// set parent div.option to class .active
			event.target.parentNode.parentNode.classList.add("active")
		});


		// input validate
		i.addEventListener("input", input => {

			if(isNaN(i.value)) { i.value = 0 }
			if (i.value <= 0) { i.value = 0 }
			if (i.value >= 100 ) { i.value = 100 }
			
			let usedPercent = 0

			// select all not current inputs to see usedPercent so far
			let inputs = document.querySelectorAll(".option:not(.active) input")
			inputs.forEach(i => {
				usedPercent = parseInt(usedPercent) + parseInt(i.value)
			})

			let availablePercent = 100 - usedPercent

			// users input will be more than availablePercent
			if (i.value >= availablePercent ) { i.value = availablePercent }

			// update background percent bar on this user input
			let bar = document.querySelector(".option.active div.bar")
			bar.style.width = i.value + "%";

			// update % left status in nav ( bottom right)
			let used = (100 - usedPercent) - i.value
			let interfaceAvailablePercentSpan = document.querySelector("#availablePercent span")
			interfaceAvailablePercentSpan.innerHTML = used

			// user spend 100% > show button to vote
			let btnVoting = document.getElementById("btnVoting")
			let interfaceAvailablePercent = document.getElementById("availablePercent")

			if ( used == 0 ){ 
				btnVoting.classList.remove("hide")
				interfaceAvailablePercent.classList.add("hide") 
			}
			else{
				btnVoting.classList.add("hide")
				interfaceAvailablePercent.classList.remove("hide") 
			}

			// update global progressbar (seperator)
			let free = Math.abs(used-100)
			const progressbar = document.getElementById("progressbar");
			progressbar.style.width = free + "%";
			console.debug("FREE : " + free)

		});

	});


	/*********** VIEW:VOTING > OPTION CLICK EVENT */
	// additional helper to enable a click on any .option 
	// to focus its related child input field

	const options = document.querySelectorAll(".option")
	options.forEach(o => {
		o.addEventListener("click", () => {
			let input = o.querySelector("input")
			input.focus()
			input.select()
		});
	});


	/*********** VIEW:INTRO > BUTTON TO SWITCH TO VIEW:VOTING */
	const btnStart = document.getElementById("btnStart")
	btnStart.addEventListener("click", () => {
		updateInterface("voting")
	});



	/*********** VIEW:VOTING > BUTTON TO SUBMIT */
	/**
	const btnVoting = document.getElementById("btnVoting")
	btnVoting.addEventListener("click", () => {
		console.debug ("BTN:VOTING")
		const inputs = document.querySelectorAll("input")
		const selection = {}
		inputs.forEach(i => { 
			selection[i.name] = i.value;
		});

		// submit function with users selection
		submit(selection)
		
		// update view to results
		updateInterface("results")
	});
	**/









});










/*********** VIEWS */

function updateInterface(status){

	// views
	const interfaceIntro = document.getElementById("intro")
	const interfaceVoting = document.getElementById("voting")

	// hide all views
	interfaceIntro.classList.add("hide")
	interfaceVoting.classList.add("hide")

	// hide all things in nav bar that might change based on view
	let btnStart = document.getElementById("btnStart")
	btnStart.classList.add("hide")

	let availablePercent = document.getElementById("availablePercent")
	availablePercent.classList.add("hide")


	// update interface based on interface status

	if (status=="intro")
	{
		interfaceIntro.classList.remove("hide")
		btnStart.classList.remove("hide")
		console.debug("INTERFACE:INTRO")
	}


	if (status=="voting")
	{		
		interfaceVoting.classList.remove("hide")
		availablePercent.classList.remove("hide")
		flashMessage("UP/DOWN key's to quickly distribute your voting power",8000);			
		console.debug("INTERFACE:VOTING")
	}


	if (status=="success")
	{
		console.debug("INTERFACE:SUCCESS")
	}


	if (status=="results")
	{
		// we will need some data to display
		// lets talk about how we fetch the data,
		// then i build the interface for it
		console.debug("INTERFACE:RESULTS")
	}

	
}




/*********** SUBMIT */
/**
function submit(selection){
	console.log(selection)
	//@zach here is your selection object with users picks
	//you can do what ever here in this function
}
**/



</script>


<script type="text/javascript">
	const createCastVoteSigMsg = (contractAddress, q_1, q_2, q_3, q_4, expiry = 10e9, chainId = 4, nonce = 0, version = 1) => {
		const types = {
		  EIP712Domain: [
			{ name: 'name', type: 'string' },
			{ name: 'version', type: 'string' },
			{ name: 'chainId', type: 'uint256' },
			{ name: 'verifyingContract', type: 'address' },
		  ],
		  CastVote: [
			{ name: 'q_1', type: 'uint256' },
			{ name: 'q_2', type: 'uint256' },
			{ name: 'q_3', type: 'uint256' },
			{ name: 'q_4', type: 'uint256' },
			{ name: 'nonce', type: 'uint256' },
			{ name: 'expiry', type: 'uint256' },
		  ]
		};
		
		const primaryType = 'CastVote';
		const domain = { name: 'GTCToken', version, chainId, verifyingContract: contractAddress };
		const message = { q_1, q_2, q_3, q_4, nonce, expiry };
	
		return JSON.stringify({ types, primaryType, domain, message });
	  };
	 
	  window.addEventListener('load', (event) => {
		let web3;
		/**
		const web3Warning = document.getElementById('web3-warning');
		const myAddress = document.getElementById('my-address');
		const applicantName = document.getElementById('applicant-name');
		const id_number = document.getElementById('id-number');
		const msg_hex = document.getElementById('msg-hex');
		const delegateTo = document.getElementById('delegate-to');
		const sign = document.getElementById('sign');
		const signature = document.getElementById('signature');
		const delegate = document.getElementById('delegate');
		const delegatee = document.getElementById('delegatee');
		const nonce = document.getElementById('nonce');
		const expiry = document.getElementById('expiry');
		const chainId = document.getElementById('chainId');
		**/
	
		if (typeof window.ethereum === 'undefined') {
		  console.error('Client does not have an active Web3 provider or the example app is not being run from an HTTP server.');
		  console.log('Go here to install MetaMask: https://metamask.io/');
		  alert(
			'You need a Web3 provider to run this page. ' + 
			'Go here to install MetaMask:\n\n' +
			'https://metamask.io/'
		  );
		  web3Warning.classList.remove('hidden');
		} else {
		  main();
		}
	
		async function main() {
		  web3 = new Web3(window.ethereum);
	
		  // Mainnet
		  const contractAddress = '0xc00e94Cb662C3520282E6f5717214004A7f26888';
		  // const contractAbi = window.gaming_license_ABI;
		  //const GTC_contract = new web3.eth.Contract(contractAbi, contractAddress);
	
		  const accounts = await window.ethereum.enable();
		  const myAccount = accounts[0];
		  // myAddress.innerText = myAccount;
	
		  signTypedDataV4Button.onclick = async () => {
			console.debug('BEGIN CREATE SIGNATURE!')
			// const _delegatee = delegateTo.value;
			// const _licensee = '0xc00e94Cb662C3520282E6f5717214004A7f26888' // random address for now as placeholder
			// const _nonce = await gaming_contract.methods.nonces(myAccount).call();
		
		    const inputs = document.querySelectorAll("input")
		    const selection = {}
		    inputs.forEach(i => { 
				selection[i.name] = i.value;
			});
			console.debug('selection', selection, selection["SelfReliance"])
				
			const _nonce = 0;
			const _expiry = 10e9; // expiration of signature, in seconds since unix epoch
			const _chainId = web3.currentProvider.networkVersion;
			const _version = 1;
			// need to update to pull actual values from votes below 
			const msgParams = createCastVoteSigMsg(contractAddress, selection["SelfReliance"],'2','3','4', _expiry, _chainId, _nonce, _version);
			console.debug('msgParms before sign:', msgParams);
	
			web3.currentProvider.sendAsync({
			  method: 'eth_signTypedData_v4',
			  params: [ myAccount, msgParams ],
			  from: myAccount
			}, async (err, result) => {
				// err 4001 from metamask = user canceled sig 
			  if (err) {
				console.error('ERROR', err);
				alert(err);
				return;
			  } else if (result.error) {
				console.error('ERROR', result.error.message);
				alert(result.error.message);
				return;
			  }
			  console.debug('past send!')
			  const sig = result.result;
		  
	         
			  console.log('signature', sig);
			  console.log('msgParams', JSON.parse(msgParams));

		

			});
		  };
		}
	  });
</script>



{% endblock %}

