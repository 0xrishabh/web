{% extends 'quadraticlands/components/base.html' %}
{% load humanize static i18n %}
{% block 'content' %}
	<section class="column">
		<p>web3</p>
	</section>
{% endblock %}
{% block 'scripts' %}
	<!--some custom particles-->
	<script src="/static/quadraticlands/js/particles.js"></script>
	<!--Scroll Animation Library (sal) INIT-->
	<script src="/static/quadraticlands/js/sal_init.js"></script>
	<!--APP - burger menu, wallet menu, provider select-->
	<script src="/static/quadraticlands/js/app.js"></script>
	<!-- this page NEEDS a Wallet and will force the Web3Modal -->
	<script src="/static/quadraticlands/js/forceWallet.js"></script>
	<!-- contract ABIs & address info-->
	<script src="{% static "v2/js/abi.js" %}"></script>
	<script src="/static/quadraticlands/js/web3-samples.js"></script>
	<script>
		function web3Ready() {
		  console.debug('WEB3 version from script', web3.version);
		  // some examples of getting data from the GTC and tokenDist contracts 

		  // get token balance - (using generic ERC20 function from Octos wallet file)
		  getTokenBalances(gtc_address()).then(function(result) {
				 console.debug('ERC20 TokenBalance:', result.balance);
		  });

		  // get current votes 
		  getCurrentVotes(gtc_address()).then(function(result) { 
			  console.debug('Current GTC Votes:', result);
		  });

		 // get prior votes by block number 
		 block_number = 4242424
		 getPriorVotes(gtc_address(), selectedAccount, block_number).then(function(result) { 
			  console.debug('Current GTC Votes:', result);
		  });
		}
	    document.addEventListener("dataWalletReady", web3Ready);
	</script>

    <script>
		/**
		*  * Gets the current votes balance for an address from GTC Token contract.
		*  * @param {string} tokenAddress - the ERC20 token address
		*  */
		async function getCurrentVotes(tokenAddress) {
		
			// Get GTC Token contract instance
			let GTCContract = new web3.eth.Contract(gtc_token_abi, tokenAddress);
			
			// Call getCurrentVotes function
			try {
			    current_votes = GTCContract.methods.getCurrentVotes(selectedAccount).call({from: selectedAccount})
			} catch(e) {
				console.log('Could not get prior votes: ', e);
				return
			}
			return current_votes;
		}

       	/**
		*  * Gets the past votes balance at a given block for an address from GTC Token contract 
		*  * @param {string} tokenAddress - the ERC20 token address
		*  */
		async function getPriorVotes(tokenAddress, account, block_number) {
		
			// Get GTC Token contract instance
			let GTCContract = new web3.eth.Contract(gtc_token_abi, tokenAddress);
			
			// Call getPriorVotes function
			try {
				past_votes = GTCContract.methods.getPriorVotes(account, block_number).call({from: selectedAccount})
			} catch (e) {
			    console.log('Could not get prior votes: ', e);
				return;
			}
			return past_votes;
		}

	</script>


{% endblock %}